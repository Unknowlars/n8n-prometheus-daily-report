{
  "name": "n8n-prometheus-daily-report",
  "nodes": [
    {
      "parameters": {},
      "id": "d1adc732-ef98-4609-bac6-3cf5d69894d2",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -800,
        512
      ]
    },
    {
      "parameters": {
        "jsCode": "// ==========================================\n// CONFIGURATION v3.0 - ULTIMATE EDITION (v2.1 enhancements)\n// ==========================================\n\nconst cfg = {\n  // CORE SETTINGS\n  base_url: 'http://192.168.0.85:8428',\n  allowed_instances: 'vm-host-docker,ubuntu-4gb-hel1-2,truenas,pve,proxmox-backup-server,docker-proxmox,cachyos-valby,aarhus-pi',\n  \n  // METRIC SELECTORS\n  node_job_regex: 'integrations/node_exporter',\n\n  // CHANGE: adds tailscale\n  net_device_filter: '^(lo|veth.*|docker.*|br-.*|cni.*|flannel.*|tun.*|tap.*|wg.*|cali.*|tailscale.*)$',\n\n  disk_device_filter: '^(loop.*|dm-.*|md.*|zram.*|sr[0-9]+)$',\n  mounts_filter: 'fstype!~\"tmpfs|overlay|squashfs|proc|sysfs|devtmpfs|autofs\", device!~\"rootfs\", mountpoint!~\"^/run/.*|^/snap/.*|^/var/lib/docker/overlay2.*\"',\n\n  // ADD: Wireless interfaces filter (often down, not critical)\n  wireless_interfaces: '^(wlan.*|wlp.*|wifi.*|tailscale.*)$',\n\n  // ADD: Network capacity per host (for saturation detection)\n  network_capacity: {\n    'truenas': 10000000000,\n    'pve': 1000000000,\n    'default': 1000000000\n  },\n  \n  // THRESHOLDS\n  thresholds: {\n    cpu_warn: 85, cpu_crit: 95,\n    mem_warn: 80, mem_crit: 90,\n    fs_warn: 85, fs_crit: 95,\n    tcp_warn: 1000, tcp_crit: 50000,\n    disk_latency_warn: 50, // ms\n    disk_latency_crit: 100,\n    net_drops_warn: 1000, // 24h\n    net_drops_crit: 10000,\n    load_warn: 2.0, // per CPU core\n    load_crit: 4.0\n  },\n  \n  // HOST-SPECIFIC OVERRIDES\n  overrides: {\n    'truenas': { mem_warn: 98, mem_crit: 99 },\n    'aarhus-pi': { cpu_warn: 90 }\n  },\n  \n  // MULTI-SITE CONFIGURATION\n  sites: {\n    'copenhagen': ['pve', 'truenas', 'proxmox-backup-server', 'docker-proxmox', 'vm-host-docker', 'cachyos-valby'],\n    'helsinki': ['ubuntu-4gb-hel1-2'],\n    'remote': ['aarhus-pi']\n  },\n  \n  site_sla_targets: {\n    'copenhagen': 99.9,\n    'helsinki': 99.5,\n    'remote': 95.0\n  },\n  \n  // MAINTENANCE WINDOWS (UTC time)\n  maintenance_windows: [\n    { day: 0, start: '02:00', end: '04:00' } // Sunday 2-4 AM\n  ],\n  \n  // BUSINESS HOURS (for threshold adjustment)\n  business_hours: { start: 9, end: 17 },\n  threshold_multipliers: {\n    business_hours: 1.0,\n    off_hours: 1.2,\n    weekend: 1.3\n  },\n  \n  // TRENDING & PREDICTION (Enhanced)\n  trends: {\n    lookback_days: 7,\n    detect_anomalies: true,\n    predict_disk_full: true,\n    predict_memory_leak: true,\n    predict_network_saturation: true,\n    disk_full_warn_days: 30,\n    disk_full_crit_days: 14,\n    mem_leak_warn_days: 45,\n    mem_leak_crit_days: 21\n  },\n  \n  // CONTAINER MONITORING (optional)\n  container_monitoring: false, // Set to true if you have Docker exporter\n  docker_job_regex: 'integrations/docker',\n  critical_containers: ['traefik', 'database', 'n8n'],\n  \n  // ALERTING\n  llm_model: 'essentialai/rnj-1',\n  llm_skip_on_healthy: true, // Save costs when all green\n  email_recipient: 'appletimedk@gmail.com',\n  slack_webhook: '', // Add your Slack webhook URL here\n  slack_critical_only: true,\n  \n  // REPORT CUSTOMIZATION\n  company_name: 'InfraOps',\n  report_title: 'Daily System Health Report',\n  timezone: 'Europe/Copenhagen'\n};\n\n// Build selector strings\nconst allowed = cfg.allowed_instances.split(',').map(s => s.trim()).filter(Boolean);\nconst instanceRegex = allowed.length\n  ? `^(${allowed.map(x => x.replace(/[.*+?^${}()|[\\\\\\\\]\\\\\\\\]/g, '\\\\\\\\$&')).join('|')})(:.*)?$`\n  : '^.+$';\n\nconst ns = `job=~'${cfg.node_job_regex}',instance=~'${instanceRegex}'`;\nconst ds = `${ns},device!~'${cfg.disk_device_filter}'`;\nconst nets = `${ns},device!~'${cfg.net_device_filter}'`;\nconst fss = `${ns},${cfg.mounts_filter.replace(/\"/g, \"'\")}`;\n\nreturn [{\n  json: {\n    base_url: cfg.base_url,\n    node_selector: ns,\n    disk_selector: ds,\n    net_selector: nets,\n    fs_selector: fss,\n    allowed_instances: allowed,\n    thresholds: cfg.thresholds,\n    overrides: cfg.overrides,\n    sites: cfg.sites,\n    site_sla_targets: cfg.site_sla_targets,\n    maintenance_windows: cfg.maintenance_windows,\n    business_hours: cfg.business_hours,\n    threshold_multipliers: cfg.threshold_multipliers,\n    trends: cfg.trends,\n\n    // ADD to return\n    network_capacity: cfg.network_capacity,\n    wireless_interfaces: cfg.wireless_interfaces,\n\n    container_monitoring: cfg.container_monitoring,\n    docker_job_regex: cfg.docker_job_regex,\n    docker_selector: cfg.container_monitoring ? `job=~'${cfg.docker_job_regex}'` : null,\n    critical_containers: cfg.critical_containers,\n    llm_model: cfg.llm_model,\n    llm_skip_on_healthy: cfg.llm_skip_on_healthy,\n    email_recipient: cfg.email_recipient,\n    slack_webhook: cfg.slack_webhook,\n    slack_critical_only: cfg.slack_critical_only,\n    company_name: cfg.company_name,\n    report_title: cfg.report_title,\n    timezone: cfg.timezone\n  }\n}];"
      },
      "id": "36de052d-4fd2-4c53-92d9-d3aded97e3aa",
      "name": "Configuration v3.0",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        512
      ]
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'up{' + $items('Configuration v3.0')[0].json.node_selector + '}' }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "9ed35af4-bb1e-441b-9b44-554e76c68820",
      "name": "Query: up",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        0
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'avg_over_time(up{' + $items('Configuration v3.0')[0].json.node_selector + '}[24h]) * 100' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "637b9066-3e8d-4fbc-a338-960de72704a1",
      "name": "Query: avail_24h",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        112
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ '100 - (avg by (instance) (rate(node_cpu_seconds_total{' + $items('Configuration v3.0')[0].json.node_selector + ',mode=\"idle\"}[5m])) * 100)' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8ad4ba95-ddb3-40c6-b164-160539e0f47a",
      "name": "Query: cpu_usage",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        208
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query_range",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ '100 - (avg by (instance) (rate(node_cpu_seconds_total{' + $items('Configuration v3.0')[0].json.node_selector + ',mode=\"idle\"}[5m])) * 100)' }}"
            },
            {
              "name": "start",
              "value": "={{ Math.floor(Date.now()/1000) - 604800 }}"
            },
            {
              "name": "end",
              "value": "={{ Math.floor(Date.now()/1000) }}"
            },
            {
              "name": "step",
              "value": "1h"
            }
          ]
        },
        "options": {}
      },
      "id": "06cf819d-92c6-4ea4-a9e3-fc30ee5a983e",
      "name": "Query: cpu_trend_7d",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        304
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'node_load1{' + $items('Configuration v3.0')[0].json.node_selector + '} / clamp_min(count by (instance) (node_cpu_seconds_total{' + $items('Configuration v3.0')[0].json.node_selector + ',mode=\"idle\"}), 1)' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "1dd2c1ef-3600-43c8-9860-d5a8698db286",
      "name": "Query: load_per_cpu",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        400
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ '(1 - (node_memory_MemAvailable_bytes{' + $items('Configuration v3.0')[0].json.node_selector + '} / node_memory_MemTotal_bytes{' + $items('Configuration v3.0')[0].json.node_selector + '})) * 100' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "311ea949-813b-49ee-9727-0a815c8aa550",
      "name": "Query: mem_usage",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        512
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query_range",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ '(1 - (node_memory_MemAvailable_bytes{' + $items('Configuration v3.0')[0].json.node_selector + '} / node_memory_MemTotal_bytes{' + $items('Configuration v3.0')[0].json.node_selector + '})) * 100' }}"
            },
            {
              "name": "start",
              "value": "={{ Math.floor(Date.now()/1000) - 604800 }}"
            },
            {
              "name": "end",
              "value": "={{ Math.floor(Date.now()/1000) }}"
            },
            {
              "name": "step",
              "value": "1h"
            }
          ]
        },
        "options": {}
      },
      "id": "db2a7f19-3b0e-4066-b9dd-e5d7606692c4",
      "name": "Query: mem_trend_7d",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        608
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ '(1 - (node_memory_SwapFree_bytes{' + $items('Configuration v3.0')[0].json.node_selector + '} / clamp_min(node_memory_SwapTotal_bytes{' + $items('Configuration v3.0')[0].json.node_selector + '}, 1))) * 100' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "25762366-f300-4b11-855c-59d64e2e3b9a",
      "name": "Query: swap_usage",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        704
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'node_filesystem_size_bytes{' + $items('Configuration v3.0')[0].json.fs_selector + '}' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8fca4c2a-cf8c-4748-abbe-bd9a52737df9",
      "name": "Query: fs_size",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        800
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'node_filesystem_avail_bytes{' + $items('Configuration v3.0')[0].json.fs_selector + '}' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c57a5a58-a6a5-4d4a-8557-7b1517a0c776",
      "name": "Query: fs_avail",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        912
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query_range",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ '(1 - (node_filesystem_avail_bytes{' + $items('Configuration v3.0')[0].json.fs_selector + '} / node_filesystem_size_bytes{' + $items('Configuration v3.0')[0].json.fs_selector + '})) * 100' }}"
            },
            {
              "name": "start",
              "value": "={{ Math.floor(Date.now()/1000) - 604800 }}"
            },
            {
              "name": "end",
              "value": "={{ Math.floor(Date.now()/1000) }}"
            },
            {
              "name": "step",
              "value": "6h"
            }
          ]
        },
        "options": {}
      },
      "id": "46a61ce0-a53b-4731-9890-cb8cc37d2d64",
      "name": "Query: disk_growth_7d",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        1008
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'max by (instance) (rate(node_disk_io_time_seconds_total{' + $items('Configuration v3.0')[0].json.disk_selector + '}[5m]) * 100)' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "01903646-c389-4056-8d66-2a624e8a4c98",
      "name": "Query: disk_busy",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        1104
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (rate(node_disk_read_time_seconds_total{' + $items('Configuration v3.0')[0].json.disk_selector + '}[5m]) / clamp_min(rate(node_disk_reads_completed_total{' + $items('Configuration v3.0')[0].json.disk_selector + '}[5m]), 0.0001)) * 1000' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8a227fd8-3cd3-4df1-a6c3-578fdf2ceafb",
      "name": "Query: disk_read_lat",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        1200
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (rate(node_disk_write_time_seconds_total{' + $items('Configuration v3.0')[0].json.disk_selector + '}[5m]) / clamp_min(rate(node_disk_writes_completed_total{' + $items('Configuration v3.0')[0].json.disk_selector + '}[5m]), 0.0001)) * 1000' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "d62a5e65-b372-434c-b771-fb46a3d4140b",
      "name": "Query: disk_write_lat",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        1312
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (rate(node_network_receive_bytes_total{' + $items('Configuration v3.0')[0].json.net_selector + '}[5m])) * 8' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8720b630-c8e5-4611-b34a-6574bb3606a9",
      "name": "Query: net_rx",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        0
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (rate(node_network_transmit_bytes_total{' + $items('Configuration v3.0')[0].json.net_selector + '}[5m])) * 8' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "3478aad9-d918-4ece-8207-1c926d96d1bc",
      "name": "Query: net_tx",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        112
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (increase(node_network_receive_drop_total{' + $items('Configuration v3.0')[0].json.net_selector + '}[24h]))' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "6778883f-4efa-482a-9254-7bfe648a6e2c",
      "name": "Query: net_drop_rx",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        208
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (increase(node_network_transmit_drop_total{' + $items('Configuration v3.0')[0].json.net_selector + '}[24h]))' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "91501e2b-ce67-4421-9a7f-2eec585b510e",
      "name": "Query: net_drop_tx",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        304
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (increase(node_network_receive_errs_total{' + $items('Configuration v3.0')[0].json.net_selector + '}[24h]))' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "930ab18b-4a08-43e3-ac9f-4ec09739129f",
      "name": "Query: net_err_rx",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        400
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (increase(node_network_transmit_errs_total{' + $items('Configuration v3.0')[0].json.net_selector + '}[24h]))' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f2f71df3-45dd-4698-a5df-441f16bcc81e",
      "name": "Query: net_err_tx",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        512
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'node_network_up{' + $items('Configuration v3.0')[0].json.net_selector + '}' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f23c9b72-2f10-408e-85d3-71e62ed36f91",
      "name": "Query: net_interface_status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        608
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (node_netstat_Tcp_CurrEstab{' + $items('Configuration v3.0')[0].json.node_selector + '})' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e30e6a51-dd21-49ae-bdb3-67fb0f13fffb",
      "name": "Query: tcp_estab",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        704
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'sum by (instance) (increase(node_netstat_Tcp_RetransSegs{' + $items('Configuration v3.0')[0].json.node_selector + '}[24h]))' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ab4270cf-3cb2-42c3-bf03-829a0508f643",
      "name": "Query: tcp_retrans",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        800
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'node_time_seconds{' + $items('Configuration v3.0')[0].json.node_selector + '} - node_boot_time_seconds{' + $items('Configuration v3.0')[0].json.node_selector + '}' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "5837ae86-6607-4056-a531-3ae9077dba62",
      "name": "Query: uptime",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        912
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'changes(node_boot_time_seconds{' + $items('Configuration v3.0')[0].json.node_selector + '}[7d])' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "eb56deff-2e69-4ca7-9fd6-490098baeac1",
      "name": "Query: reboots",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        1008
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'node_uname_info{' + $items('Configuration v3.0')[0].json.node_selector + '}' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "df61b1d8-4c9f-4e76-afd9-c2bf6763cba0",
      "name": "Query: uname",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        1104
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'count by (instance) (count by (instance, cpu) (node_cpu_seconds_total{' + $items('Configuration v3.0')[0].json.node_selector + ',mode=\"idle\"}))' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e6dbed65-49e8-4a2f-8013-f3bc1a5fb544",
      "name": "Query: cpu_count",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        1200
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $items('Configuration v3.0')[0].json.base_url }}/api/v1/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ 'node_memory_MemTotal_bytes{' + $items('Configuration v3.0')[0].json.node_selector + '}' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ecc6d091-5b0c-4c7b-866f-3271397620ef",
      "name": "Query: mem_total",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        1312
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ==========================================\n// COMBINE METRICS v6.0 - ULTIMATE EDITION (v2.1 prediction engine)\n// ==========================================\n\nconst cfg = $items('Configuration v3.0')?.[0]?.json || {};\nconst TH = cfg.thresholds || {};\n\nconst toNumber = v => { const n = parseFloat(v); return Number.isFinite(n) ? n : null; };\nconst round = (v, decimals = 1) => { const n = toNumber(v); return n !== null ? Number(n.toFixed(decimals)) : null; };\nconst baseInstance = inst => String(inst || 'unknown').split(':')[0];\n\nfunction safeResults(nodeName) {\n  try {\n    const items = $items(nodeName);\n    if (!items?.[0]?.json) return [];\n    const json = items[0].json;\n    if (json.data?.result) return json.data.result;\n    if (Array.isArray(json.result)) return json.result;\n    return [];\n  } catch (e) { return []; }\n}\n\nclass HostManager {\n  constructor(allowed) {\n    this.hosts = {};\n    this.allowed = allowed.map(baseInstance);\n    this.allowed.forEach(inst => this.getHost(inst));\n  }\n  getHost(instanceAny) {\n    const inst = baseInstance(instanceAny);\n    if (!this.hosts[inst]) {\n      this.hosts[inst] = { instance: inst, hostname: inst, filesystems: [], alerts: [], trends: {} };\n    }\n    return this.hosts[inst];\n  }\n  getFilteredHosts() {\n    const all = Object.values(this.hosts);\n    return this.allowed.length === 0 ? all : all.filter(h => this.allowed.includes(h.instance));\n  }\n}\n\nconst hosts = new HostManager(cfg.allowed_instances || []);\n\nfunction assignMetric(results, field, decimals = 1) {\n  results.forEach(r => {\n    const host = hosts.getHost(r.metric?.instance);\n    const value = toNumber(r.value?.[1]);\n    if (value !== null) host[field] = round(value, decimals);\n  });\n}\n\n// CURRENT METRICS\nassignMetric(safeResults('Query: up'), 'is_up', 0);\nassignMetric(safeResults('Query: avail_24h'), 'availability_24h', 2);\nassignMetric(safeResults('Query: uptime'), 'uptime_seconds', 0);\nassignMetric(safeResults('Query: cpu_usage'), 'cpu_usage_percent', 1);\nassignMetric(safeResults('Query: load_per_cpu'), 'cpu_load_normalized', 2);\nassignMetric(safeResults('Query: mem_usage'), 'mem_usage_percent', 1);\nassignMetric(safeResults('Query: swap_usage'), 'swap_usage_percent', 1);\nassignMetric(safeResults('Query: disk_busy'), 'disk_busy_percent', 1);\nassignMetric(safeResults('Query: disk_read_lat'), 'disk_read_lat_ms', 1);\nassignMetric(safeResults('Query: disk_write_lat'), 'disk_write_lat_ms', 1);\nassignMetric(safeResults('Query: net_rx'), 'net_rx_bps', 0);\nassignMetric(safeResults('Query: net_tx'), 'net_tx_bps', 0);\nassignMetric(safeResults('Query: net_drop_rx'), 'net_drop_rx_24h', 0);\nassignMetric(safeResults('Query: net_drop_tx'), 'net_drop_tx_24h', 0);\nassignMetric(safeResults('Query: net_err_rx'), 'net_err_rx_24h', 0);\nassignMetric(safeResults('Query: net_err_tx'), 'net_err_tx_24h', 0);\nassignMetric(safeResults('Query: tcp_estab'), 'tcp_established', 0);\nassignMetric(safeResults('Query: tcp_retrans'), 'tcp_retrans_24h', 0);\nassignMetric(safeResults('Query: reboots'), 'reboots_7d', 0);\n\n// SYSTEM INFO\nsafeResults('Query: uname').forEach(r => {\n  const host = hosts.getHost(r.metric?.instance);\n  host.hostname = r.metric?.nodename || host.hostname;\n  host.kernel = r.metric?.release || '';\n  host.os = r.metric?.sysname || '';\n});\n\nassignMetric(safeResults('Query: cpu_count'), 'cpu_cores', 0);\nassignMetric(safeResults('Query: mem_total'), 'mem_total_bytes', 0);\n\n// FILESYSTEM CALCULATION\nconst fsMap = {};\nsafeResults('Query: fs_size').forEach(r => {\n  const inst = r.metric?.instance;\n  const mount = r.metric?.mountpoint;\n  if (inst && mount) {\n    const key = `${inst}|${mount}`;\n    if (!fsMap[key]) fsMap[key] = { instance: inst, mount: mount };\n    fsMap[key].size = toNumber(r.value?.[1]);\n  }\n});\n\nsafeResults('Query: fs_avail').forEach(r => {\n  const inst = r.metric?.instance;\n  const mount = r.metric?.mountpoint;\n  if (inst && mount) {\n    const key = `${inst}|${mount}`;\n    if (!fsMap[key]) fsMap[key] = { instance: inst, mount: mount };\n    fsMap[key].avail = toNumber(r.value?.[1]);\n  }\n});\n\nObject.values(fsMap).forEach(fs => {\n  if (fs.size > 0 && fs.avail !== null) {\n    const usedPct = ((fs.size - fs.avail) / fs.size) * 100;\n    const host = hosts.getHost(fs.instance);\n    if (host.fs_usage_percent === undefined || usedPct > host.fs_usage_percent) {\n      host.fs_usage_percent = round(usedPct, 1);\n      host.fs_max_mount = fs.mount;\n      host.fs_size_gb = round(fs.size / 1073741824, 1);\n      host.fs_avail_gb = round(fs.avail / 1073741824, 1);\n    }\n  }\n});\n\n// TRENDING DATA (7-day)\nfunction extractTrendData(results) {\n  const trends = {};\n  results.forEach(r => {\n    const inst = baseInstance(r.metric?.instance);\n    if (!trends[inst]) trends[inst] = [];\n    const values = r.values || [];\n    values.forEach(([timestamp, value]) => {\n      trends[inst].push({ time: timestamp, value: toNumber(value) });\n    });\n  });\n  return trends;\n}\n\nconst cpuTrends = extractTrendData(safeResults('Query: cpu_trend_7d'));\nconst memTrends = extractTrendData(safeResults('Query: mem_trend_7d'));\nconst diskGrowthData = extractTrendData(safeResults('Query: disk_growth_7d'));\n\nObject.keys(cpuTrends).forEach(inst => {\n  const host = hosts.getHost(inst);\n  const values = cpuTrends[inst].map(d => d.value).filter(v => v !== null);\n  if (values.length > 0) {\n    host.trends.cpu_7d_avg = round(values.reduce((a, b) => a + b, 0) / values.length, 1);\n    host.trends.cpu_7d_max = round(Math.max(...values), 1);\n    host.trends.cpu_sparkline = values.slice(-24);\n  }\n});\n\nObject.keys(memTrends).forEach(inst => {\n  const host = hosts.getHost(inst);\n  const values = memTrends[inst].map(d => d.value).filter(v => v !== null);\n  if (values.length > 0) {\n    host.trends.mem_7d_avg = round(values.reduce((a, b) => a + b, 0) / values.length, 1);\n    host.trends.mem_7d_max = round(Math.max(...values), 1);\n    host.trends.mem_sparkline = values.slice(-24);\n  }\n});\n\n// ==========================================\n// ADVANCED PREDICTION ENGINE v2.1\n// ==========================================\n\nconst trendsConfig = cfg.trends || {};\nconst networkCapacity = cfg.network_capacity || {};\n\n// 1. DISK GROWTH PREDICTION (Enhanced)\nif (trendsConfig.predict_disk_full) {\n  Object.keys(diskGrowthData).forEach(inst => {\n    const host = hosts.getHost(inst);\n    const data = diskGrowthData[inst];\n    if (data.length >= 10) {\n      const recent = data.slice(-10);\n      const oldestUsage = recent[0].value;\n      const newestUsage = recent[recent.length - 1].value;\n      if (oldestUsage !== null && newestUsage !== null && newestUsage > oldestUsage) {\n        const timeSpanDays = (recent[recent.length - 1].time - recent[0].time) / 86400;\n        const usageGrowth = newestUsage - oldestUsage;\n        const dailyGrowthRate = usageGrowth / timeSpanDays;\n        const remainingSpace = 100 - (host.fs_usage_percent || 0);\n        const daysUntilFull = remainingSpace / dailyGrowthRate;\n        if (daysUntilFull > 0 && daysUntilFull < 365) {\n          host.disk_full_in_days = Math.round(daysUntilFull);\n          host.disk_growth_rate_daily = round(dailyGrowthRate, 2);\n          host.disk_growth_gb_per_week = round((host.fs_size_gb || 0) * (dailyGrowthRate / 100) * 7, 1);\n        }\n      }\n    }\n  });\n}\n\n// 2. MEMORY LEAK DETECTION (NEW!)\nif (trendsConfig.predict_memory_leak) {\n  Object.keys(memTrends).forEach(inst => {\n    const host = hosts.getHost(inst);\n    const data = memTrends[inst];\n    \n    if (data.length >= 20) {\n      const values = data.map(d => d.value).filter(v => v !== null);\n      if (values.length < 20) return;\n      \n      // Calculate variance\n      const avg = values.reduce((a, b) => a + b, 0) / values.length;\n      const variance = values.reduce((sq, n) => sq + Math.pow(n - avg, 2), 0) / values.length;\n      const stdDev = Math.sqrt(variance);\n      const coefficientOfVariation = (stdDev / avg) * 100;\n      \n      const recent = data.slice(-20);\n      const oldestMem = recent[0].value;\n      const newestMem = recent[recent.length - 1].value;\n      \n      if (oldestMem !== null && newestMem !== null && newestMem > oldestMem) {\n        const timeSpanDays = (recent[recent.length - 1].time - recent[0].time) / 86400;\n        const memGrowth = newestMem - oldestMem;\n        const dailyMemGrowth = memGrowth / timeSpanDays;\n        \n        // ðŸŽ¯ KEY FIX: Only flag if low variance (steady growth)\n        const isLowVariance = coefficientOfVariation < 12;  // Less than 12% variance\n        const isSteadyGrowth = dailyMemGrowth > 5.0;        // More than 1%/day\n        \n        if (isLowVariance && isSteadyGrowth) {\n          const currentMem = host.mem_usage_percent || 0;\n          const threshold = 90;\n          const remainingMem = threshold - currentMem;\n          const daysUntilMemPressure = remainingMem / dailyMemGrowth;\n          \n          if (daysUntilMemPressure > 0 && daysUntilMemPressure < 90) {\n            host.mem_pressure_in_days = Math.round(daysUntilMemPressure);\n            host.mem_growth_rate_daily = round(dailyMemGrowth, 2);\n            host.mem_weekly_growth = round(dailyMemGrowth * 7, 1);\n            host.mem_variance_pct = round(coefficientOfVariation, 1);\n            host.prediction_type = daysUntilMemPressure < 30 ? 'memory_leak_likely' : 'memory_growth_detected';\n          }\n        }\n      }\n    }\n  });\n}\n\n// 3. CPU ANOMALY DETECTION (NEW!)\nif (trendsConfig.detect_anomalies) {\n  Object.keys(cpuTrends).forEach(inst => {\n    const host = hosts.getHost(inst);\n    const values = cpuTrends[inst].map(d => d.value).filter(v => v !== null);\n    if (values.length > 20) {\n      const avg = values.reduce((a, b) => a + b, 0) / values.length;\n      const max = Math.max(...values);\n      const stdDev = Math.sqrt(values.reduce((sq, n) => sq + Math.pow(n - avg, 2), 0) / values.length);\n\n      // Anomaly: max is >3 std deviations from mean\n      if (stdDev > 5 && (max - avg) > (3 * stdDev)) {\n        host.cpu_anomaly_detected = true;\n        host.cpu_spike_max = round(max, 1);\n        host.cpu_spike_deviation = round((max - avg) / stdDev, 1);\n      }\n    }\n  });\n}\n\n// 4. NETWORK BANDWIDTH SATURATION (NEW!)\nif (trendsConfig.predict_network_saturation) {\n  hosts.getFilteredHosts().forEach(h => {\n    if (h.net_tx_bps != null && h.net_rx_bps != null) {\n      const totalBps = (h.net_tx_bps || 0) + (h.net_rx_bps || 0);\n      const capacity = networkCapacity[h.instance] || networkCapacity['default'] || 1000000000;\n      const utilizationPct = (totalBps / capacity) * 100;\n\n      h.network_utilization_pct = round(utilizationPct, 1);\n      h.network_capacity_bps = capacity;\n\n      if (utilizationPct > 70) {\n        h.network_saturation_risk = true;\n      }\n    }\n  });\n}\n\n// 5. DISK I/O PATTERN ANALYSIS (NEW!)\nhosts.getFilteredHosts().forEach(h => {\n  if (h.disk_write_lat_ms != null && h.disk_read_lat_ms != null) {\n    const avgLatency = (h.disk_write_lat_ms + h.disk_read_lat_ms) / 2;\n\n    if (avgLatency < 1) h.disk_performance = 'excellent';\n    else if (avgLatency < 10) h.disk_performance = 'good';\n    else if (avgLatency < 50) h.disk_performance = 'acceptable';\n    else if (avgLatency < 100) h.disk_performance = 'degraded';\n    else h.disk_performance = 'poor';\n\n    if (h.disk_write_lat_ms > h.disk_read_lat_ms * 3) {\n      h.disk_write_heavy = true;\n    }\n  }\n});\n\n// 6. UPTIME & STABILITY SCORE (NEW!)\nhosts.getFilteredHosts().forEach(h => {\n  if (h.is_up && h.uptime_seconds) {\n    const uptimeDays = h.uptime_seconds / 86400;\n    const reboots = h.reboots_7d || 0;\n\n    let score = 100;\n    if (reboots > 0) score -= reboots * 10;\n    if (uptimeDays < 1) score -= 20;\n    if (h.cpu_anomaly_detected) score -= 10;\n    if (h.mem_pressure_in_days && h.mem_pressure_in_days < 30) score -= 15;\n\n    h.stability_score = Math.max(0, Math.min(100, score));\n  }\n});\n\n// NETWORK INTERFACE STATUS\nconst interfaceStatus = {};\nsafeResults('Query: net_interface_status').forEach(r => {\n  const inst = baseInstance(r.metric?.instance);\n  const device = r.metric?.device;\n  const status = toNumber(r.value?.[1]);\n  if (inst && device && status === 0) {\n    if (!interfaceStatus[inst]) interfaceStatus[inst] = [];\n    interfaceStatus[inst].push(device);\n  }\n});\n\nObject.keys(interfaceStatus).forEach(inst => {\n  const host = hosts.getHost(inst);\n  host.interfaces_down = interfaceStatus[inst];\n});\n\n// FINALIZE\nconst filteredHosts = hosts.getFilteredHosts();\nfilteredHosts.forEach(h => {\n  h.is_up = h.is_up === 1;\n  h.display_name = h.hostname || h.instance;\n\n  if (!h.is_up) {\n    h.cpu_usage_percent = null;\n    h.mem_usage_percent = null;\n    h.fs_usage_percent = null;\n  } else {\n    if (h.fs_usage_percent === undefined) h.fs_usage_percent = 0;\n  }\n\n  h.status = h.is_up ? 'ok' : 'warn';\n});\n\nreturn [{\n  json: {\n    summary: {\n      report_date: new Date().toISOString().slice(0, 10),\n      report_time: new Date().toISOString(),\n      hosts_total: filteredHosts.length,\n      hosts_up: filteredHosts.filter(h => h.is_up).length\n    },\n    hosts: filteredHosts,\n    thresholds: TH,\n    overrides: cfg.overrides,\n    sites: cfg.sites,\n    site_sla_targets: cfg.site_sla_targets,\n    trends_config: cfg.trends\n  }\n}];"
      },
      "id": "7e636af3-e3c3-4504-8eeb-08652c0196b9",
      "name": "Combine Metrics v6.0",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        704
      ]
    },
    {
      "parameters": {
        "jsCode": "// ==========================================\n// ALERT CORRELATION ENGINE v8.0\n// Pattern Detection + Smart Thresholds (v2.1 enhancements)\n// ==========================================\n\nconst input = $json;\nconst summary = input.summary || {};\nconst hosts = input.hosts || [];\nconst globalTh = input.thresholds || {};\nconst overrides = input.overrides || {};\nconst sites = input.sites || {};\nconst siteSLA = input.site_sla_targets || {};\nconst trendsConfig = input.trends_config || {};\n\nconst cfg = $items('Configuration v3.0')?.[0]?.json || {};\nconst staticData = $getWorkflowStaticData('global');\n\nconst uptimeDays = sec => sec != null ? Math.floor(sec / 86400) : null;\nconst fmtBytes = (bps) => {\n  if (bps == null) return '0 b';\n  if (bps > 1000000000) return (bps / 1000000000).toFixed(1) + ' Gb';\n  if (bps > 1000000) return (bps / 1000000).toFixed(1) + ' Mb';\n  if (bps > 1000) return (bps / 1000).toFixed(1) + ' Kb';\n  return bps.toFixed(0) + ' b';\n};\n\n// DYNAMIC THRESHOLD ADJUSTMENT\nfunction getEffectiveThresholds(hostname) {\n  const now = new Date();\n  const hour = now.getUTCHours();\n  const day = now.getUTCDay();\n\n  const inMaintenance = (cfg.maintenance_windows || []).some(w => {\n    if (w.day !== day) return false;\n    const [startH, startM] = w.start.split(':').map(Number);\n    const [endH, endM] = w.end.split(':').map(Number);\n    const nowMin = hour * 60 + now.getUTCMinutes();\n    const startMin = startH * 60 + startM;\n    const endMin = endH * 60 + endM;\n    return nowMin >= startMin && nowMin <= endMin;\n  });\n\n  if (inMaintenance) {\n    return null;\n  }\n\n  let multiplier = 1.0;\n  const bizHours = cfg.business_hours || { start: 9, end: 17 };\n  const isBusinessHours = hour >= bizHours.start && hour < bizHours.end && day >= 1 && day <= 5;\n  const isWeekend = day === 0 || day === 6;\n\n  if (isWeekend) multiplier = cfg.threshold_multipliers?.weekend || 1.3;\n  else if (!isBusinessHours) multiplier = cfg.threshold_multipliers?.off_hours || 1.2;\n\n  const hostSpecific = overrides[hostname] || {};\n  const baseTh = { ...globalTh, ...hostSpecific };\n\n  return {\n    cpu_warn: (baseTh.cpu_warn || 85) * multiplier,\n    cpu_crit: (baseTh.cpu_crit || 95) * multiplier,\n    mem_warn: (baseTh.mem_warn || 80) * multiplier,\n    mem_crit: (baseTh.mem_crit || 90) * multiplier,\n    fs_warn: (baseTh.fs_warn || 85) * multiplier,\n    fs_crit: (baseTh.fs_crit || 95) * multiplier,\n    load_warn: baseTh.load_warn || 2.0,\n    load_crit: baseTh.load_crit || 4.0,\n    disk_latency_warn: baseTh.disk_latency_warn || 50,\n    disk_latency_crit: baseTh.disk_latency_crit || 100,\n    net_drops_warn: baseTh.net_drops_warn || 1000,\n    net_drops_crit: baseTh.net_drops_crit || 10000,\n    tcp_warn: baseTh.tcp_warn || 1000,\n    tcp_crit: baseTh.tcp_crit || 50000\n  };\n}\n\n// PATTERN DETECTION\nfunction detectPatterns(h, th) {\n  const patterns = [];\n\n  // Pattern 1: IO Bottleneck\n  if (h.cpu_load_normalized > 2 && h.disk_busy_percent > 80 &&\n      (h.disk_write_lat_ms > 50 || h.disk_read_lat_ms > 50)) {\n    patterns.push({\n      pattern: 'io_bottleneck',\n      severity: 'critical',\n      message: 'IO Bottleneck Detected',\n      details: `High CPU load (${h.cpu_load_normalized}x), disk saturation (${h.disk_busy_percent}%), and latency`,\n      root_cause: 'Storage subsystem cannot keep up with demand',\n      action: 'Run iotop to identify disk-heavy processes. Check storage array health.'\n    });\n  }\n\n  // Pattern 2: Memory Thrashing\n  if (h.mem_usage_percent > 90 && h.swap_usage_percent > 50 && h.swap_usage_percent < 99.9 &&\n      h.disk_read_lat_ms > 20) {\n    patterns.push({\n      pattern: 'memory_thrashing',\n      severity: 'critical',\n      message: 'Memory Thrashing Detected (OOM Risk)',\n      details: `Memory: ${h.mem_usage_percent}%, Swap: ${h.swap_usage_percent}%, Disk Latency: ${h.disk_read_lat_ms}ms`,\n      root_cause: 'System swapping heavily due to memory exhaustion',\n      action: 'Identify memory-hungry processes with: top -o %MEM. Consider adding RAM or killing processes.'\n    });\n  }\n\n  // Pattern 3: Network Storm\n  const totalDrops = (h.net_drop_rx_24h || 0) + (h.net_drop_tx_24h || 0);\n  if (totalDrops > 10000 && h.tcp_retrans_24h > 10000) {\n    patterns.push({\n      pattern: 'network_storm',\n      severity: 'critical',\n      message: 'Network Congestion/Storm Detected',\n      details: `Drops: ${totalDrops}, Retransmissions: ${h.tcp_retrans_24h}`,\n      root_cause: 'Network infrastructure overload or misconfiguration',\n      action: 'Check switch port errors, NIC drivers (ethtool), MTU settings, and cable quality.'\n    });\n  }\n\n  // Pattern 4: Slow Disk (without high CPU)\n  if ((h.disk_write_lat_ms > 100 || h.disk_read_lat_ms > 100) && h.cpu_load_normalized < 2) {\n    patterns.push({\n      pattern: 'slow_storage',\n      severity: 'warning',\n      message: 'Abnormally Slow Disk IO',\n      details: `Write: ${h.disk_write_lat_ms}ms, Read: ${h.disk_read_lat_ms}ms`,\n      root_cause: 'Storage hardware degradation or RAID rebuild in progress',\n      action: 'Check SMART status (smartctl -a), RAID array status, and ZFS scrub/resilver.'\n    });\n  }\n\n  // Pattern 5: Interface Down (UPDATED to filter false positives)\n  if (h.interfaces_down && h.interfaces_down.length > 0) {\n    const wirelessRegex = new RegExp(cfg.wireless_interfaces || '^(wlan.*|wlp.*|tailscale.*)$');\n    const realDownInterfaces = h.interfaces_down.filter(iface => !wirelessRegex.test(iface));\n\n    if (realDownInterfaces.length > 0) {\n      patterns.push({\n        pattern: 'interface_down',\n        severity: 'warning',\n        message: `Network Interface(s) Down`,\n        details: `Down interfaces: ${realDownInterfaces.join(', ')}`,\n        root_cause: 'Physical link down or driver issue',\n        action: 'Check cable, switch port, and run: ip link show'\n      });\n    }\n  }\n\n  // Pattern 6: Memory Leak Detection\n  if (h.mem_pressure_in_days && h.mem_pressure_in_days < 45) {\n    const severity = h.mem_pressure_in_days < 21 ? 'critical' : 'warning';\n    patterns.push({\n      pattern: 'memory_leak',\n      severity: severity,\n      message: `Potential Memory Leak Detected`,\n      details: `Memory growing ${h.mem_growth_rate_daily}%/day, will hit 90% in ${h.mem_pressure_in_days} days`,\n      root_cause: 'Application memory leak or resource accumulation',\n      action: `Monitor with: watch -n 1 'ps aux --sort=-%mem | head -20'. Consider restart or memory limit increase.`\n    });\n  }\n\n  // Pattern 7: CPU Spike Anomaly\n  if (h.cpu_anomaly_detected) {\n    patterns.push({\n      pattern: 'cpu_anomaly',\n      severity: 'warning',\n      message: `Unusual CPU Spike Detected`,\n      details: `Peak: ${h.cpu_spike_max}% (${h.cpu_spike_deviation}Ïƒ above normal)`,\n      root_cause: 'Intermittent high CPU process or scheduled task',\n      action: `Review: journalctl --since \"7 days ago\" | grep -i cpu. Check cron jobs.`\n    });\n  }\n\n  // Pattern 8: Network Saturation Risk\n  if (h.network_saturation_risk) {\n    const capacityGbps = ((h.network_capacity_bps || 0) / 1000000000).toFixed(1);\n    patterns.push({\n      pattern: 'network_saturation',\n      severity: 'warning',\n      message: `Network Link Approaching Capacity`,\n      details: `${h.network_utilization_pct}% of ${capacityGbps}Gbps link utilized`,\n      root_cause: 'High bandwidth usage - may impact performance soon',\n      action: `Monitor with: iftop -i <interface>. Consider link upgrade or traffic shaping.`\n    });\n  }\n\n  // Pattern 9: Poor Disk Performance\n  if (h.disk_performance === 'degraded' || h.disk_performance === 'poor') {\n    patterns.push({\n      pattern: 'slow_disk',\n      severity: 'warning',\n      message: `Disk Performance Degraded`,\n      details: `Average latency: ${(((h.disk_write_lat_ms || 0) + (h.disk_read_lat_ms || 0)) / 2).toFixed(1)}ms (${h.disk_performance})`,\n      root_cause: 'Storage hardware degradation, high I/O, or RAID issues',\n      action: `Check: iostat -x 1 10. Review SMART: smartctl -a /dev/sd*. Check RAID status.`\n    });\n  }\n\n  return patterns;\n}\n\n// STANDARD ALERTS\nfunction generateStandardAlerts(h, th) {\n  if (!th) return [];\n\n  const alerts = [];\n\n  if (h.is_up === false) {\n    alerts.push({ level: 'critical', message: 'Host is unreachable (DOWN)' });\n    return alerts;\n  }\n\n  // CPU\n  if (h.cpu_usage_percent > th.cpu_crit)\n    alerts.push({ level: 'critical', message: `Critical CPU usage (${h.cpu_usage_percent}%)` });\n  else if (h.cpu_usage_percent > th.cpu_warn)\n    alerts.push({ level: 'warning', message: `High CPU usage (${h.cpu_usage_percent}%)` });\n\n  // CPU Load\n  if (h.cpu_load_normalized > th.load_crit)\n    alerts.push({ level: 'critical', message: `Critical System Load (${h.cpu_load_normalized}x per core)` });\n  else if (h.cpu_load_normalized > th.load_warn)\n    alerts.push({ level: 'warning', message: `High System Load (${h.cpu_load_normalized}x per core)` });\n\n  // Memory\n  if (h.mem_usage_percent > th.mem_crit)\n    alerts.push({ level: 'critical', message: `Critical Memory usage (${h.mem_usage_percent}%)` });\n  else if (h.mem_usage_percent > th.mem_warn)\n    alerts.push({ level: 'warning', message: `High Memory usage (${h.mem_usage_percent}%)` });\n\n  // Swap\n  if (h.swap_usage_percent > 80 && h.swap_usage_percent < 99.9) {\n    alerts.push({ level: 'warning', message: `High Swap Usage (${h.swap_usage_percent}%)` });\n  }\n\n  // Disk Space\n  if (h.fs_usage_percent != null && h.fs_usage_percent <= 100) {\n    if (h.fs_usage_percent > th.fs_crit)\n      alerts.push({ level: 'critical', message: `Critical Storage usage (${h.fs_usage_percent}% on ${h.fs_max_mount})` });\n    else if (h.fs_usage_percent > th.fs_warn)\n      alerts.push({ level: 'warning', message: `High Storage usage (${h.fs_usage_percent}% on ${h.fs_max_mount})` });\n  }\n\n  // Disk Full Prediction\n  if (h.disk_full_in_days != null && trendsConfig.predict_disk_full) {\n    if (h.disk_full_in_days < (trendsConfig.disk_full_crit_days || 14))\n      alerts.push({ level: 'critical', message: `Disk will be full in ${h.disk_full_in_days} days (${h.fs_max_mount})` });\n    else if (h.disk_full_in_days < (trendsConfig.disk_full_warn_days || 30))\n      alerts.push({ level: 'warning', message: `Disk will be full in ${h.disk_full_in_days} days (${h.fs_max_mount})` });\n  }\n\n  // Memory Leak Prediction\n  if (h.mem_pressure_in_days != null && trendsConfig.predict_memory_leak) {\n    if (h.mem_pressure_in_days < (trendsConfig.mem_leak_crit_days || 21))\n      alerts.push({ level: 'critical', message: `Memory will hit 90% in ${h.mem_pressure_in_days} days (leak: +${h.mem_growth_rate_daily}%/day)` });\n    else if (h.mem_pressure_in_days < (trendsConfig.mem_leak_warn_days || 45))\n      alerts.push({ level: 'warning', message: `Memory growing steadily: +${h.mem_growth_rate_daily}%/day` });\n  }\n\n  // Network Saturation\n  if (h.network_saturation_risk && trendsConfig.predict_network_saturation) {\n    alerts.push({ level: 'warning', message: `Network utilization: ${h.network_utilization_pct}% of capacity` });\n  }\n\n  // Low Stability Score\n  if (h.stability_score !== undefined && h.stability_score < 70) {\n    alerts.push({ level: 'warning', message: `Low stability score: ${h.stability_score}/100` });\n  }\n\n  // Disk Latency\n  const maxLatency = Math.max(h.disk_read_lat_ms || 0, h.disk_write_lat_ms || 0);\n  if (maxLatency > th.disk_latency_crit)\n    alerts.push({ level: 'critical', message: `Critical Disk Latency (${maxLatency}ms)` });\n  else if (maxLatency > th.disk_latency_warn)\n    alerts.push({ level: 'warning', message: `High Disk Latency (${maxLatency}ms)` });\n\n  // Network\n  const totalDrops = (h.net_drop_rx_24h || 0) + (h.net_drop_tx_24h || 0);\n  if (totalDrops > th.net_drops_crit)\n    alerts.push({ level: 'critical', message: `Severe Packet Drops (${totalDrops} in 24h)` });\n  else if (totalDrops > th.net_drops_warn)\n    alerts.push({ level: 'warning', message: `Packet Drops Detected (${totalDrops} in 24h)` });\n\n  const tcp = h.tcp_retrans_24h || 0;\n  if (tcp > th.tcp_crit)\n    alerts.push({ level: 'critical', message: `Severe Network Instability (${tcp} TCP retrans)` });\n  else if (tcp > th.tcp_warn)\n    alerts.push({ level: 'warning', message: `Network Instability (${tcp} TCP retrans)` });\n\n  // Reboots\n  if (h.reboots_7d > 0 && h.uptime_seconds < 86400) {\n    alerts.push({ level: 'warning', message: 'Host Rebooted Recently' });\n  }\n\n  return alerts;\n}\n\n// PROCESS HOSTS\nconst processedHosts = hosts.map(h => {\n  const th = getEffectiveThresholds(h.display_name);\n  const standardAlerts = generateStandardAlerts(h, th);\n  const patterns = detectPatterns(h, th);\n\n  const allAlerts = [...patterns.map(p => ({\n    level: p.severity,\n    message: p.message,\n    pattern: p.pattern,\n    details: p.details,\n    root_cause: p.root_cause,\n    action: p.action\n  })), ...standardAlerts];\n\n  let status = 'ok';\n  if (allAlerts.some(a => a.level === 'critical')) status = 'critical';\n  else if (allAlerts.length > 0) status = 'warn';\n\n  return { ...h, status, alerts: allAlerts, in_maintenance: !th };\n});\n\n// BUILD PROBLEM HOSTS SNAPSHOT\nconst problem_hosts = processedHosts\n  .filter(h => h.status !== 'ok')\n  .map(h => ({\n    display_name: h.display_name,\n    status: h.status,\n    alerts: h.alerts,\n    snapshot: {\n      uptime_days: uptimeDays(h.uptime_seconds),\n      cpu: `${h.cpu_usage_percent || 'N/A'}%`,\n      mem: `${h.mem_usage_percent || 'N/A'}%`,\n      disk: `${h.fs_usage_percent || 'N/A'}%`,\n      disk_full_days: h.disk_full_in_days || null,\n      net_traffic: `â†“${fmtBytes(h.net_rx_bps)} â†‘${fmtBytes(h.net_tx_bps)}`,\n      issues: h.alerts.map(a => a.message).join(', ')\n    }\n  }));\n\nconst healthy_hosts = {\n  count: processedHosts.filter(h => h.status === 'ok').length,\n  names: processedHosts.filter(h => h.status === 'ok').map(h => h.display_name)\n};\n\n// CALCULATE SITE SLA\nconst siteHealth = {};\nObject.keys(sites).forEach(siteName => {\n  const siteHosts = sites[siteName];\n  const siteHostData = processedHosts.filter(h => siteHosts.includes(h.instance));\n  const upCount = siteHostData.filter(h => h.is_up).length;\n  const totalCount = siteHostData.length;\n  const sla = totalCount > 0 ? ((upCount / totalCount) * 100).toFixed(2) : 0;\n  const target = siteSLA[siteName] || 99.0;\n  siteHealth[siteName] = {\n    up: upCount,\n    total: totalCount,\n    sla: parseFloat(sla),\n    target: target,\n    meets_sla: parseFloat(sla) >= target\n  };\n});\n\n// UPDATE SUMMARY\nsummary.hosts_up = processedHosts.filter(h => h.is_up).length;\nsummary.hosts_critical = processedHosts.filter(h => h.status === 'critical').length;\nsummary.hosts_warn = processedHosts.filter(h => h.status === 'warn').length;\nsummary.patterns_detected = problem_hosts.flatMap(h => h.alerts.filter(a => a.pattern)).map(a => a.pattern);\nsummary.site_health = siteHealth;\n\n// INCIDENT TRACKING\nif (!staticData.incidents) staticData.incidents = [];\nif (summary.hosts_critical > 0) {\n  const incident = {\n    timestamp: new Date().toISOString(),\n    date: summary.report_date,\n    critical_count: summary.hosts_critical,\n    hosts: problem_hosts.filter(h => h.status === 'critical').map(h => h.display_name),\n    patterns: summary.patterns_detected\n  };\n  staticData.incidents.push(incident);\n  staticData.incidents = staticData.incidents.slice(-100);\n}\n\nconst incidents_30d = staticData.incidents.filter(inc => {\n  const incDate = new Date(inc.timestamp);\n  const thirtyDaysAgo = new Date();\n  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n  return incDate >= thirtyDaysAgo;\n}).length;\n\nsummary.incidents_30d = incidents_30d;\n\n// WEEK-OVER-WEEK COMPARISON\nconst weeklyStats = processedHosts.reduce((acc, h) => {\n  if (h.trends.cpu_7d_avg != null) {\n    acc.cpu_avg_7d.push(h.trends.cpu_7d_avg);\n    acc.cpu_current.push(h.cpu_usage_percent || 0);\n  }\n  if (h.trends.mem_7d_avg != null) {\n    acc.mem_avg_7d.push(h.trends.mem_7d_avg);\n    acc.mem_current.push(h.mem_usage_percent || 0);\n  }\n  acc.tcp_retrans.push(h.tcp_retrans_24h || 0);\n  return acc;\n}, { cpu_avg_7d: [], cpu_current: [], mem_avg_7d: [], mem_current: [], tcp_retrans: [] });\n\nconst avg = arr => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;\n\nsummary.week_over_week = {\n  cpu_avg_current: avg(weeklyStats.cpu_current).toFixed(1),\n  cpu_avg_7d: avg(weeklyStats.cpu_avg_7d).toFixed(1),\n  mem_avg_current: avg(weeklyStats.mem_current).toFixed(1),\n  mem_avg_7d: avg(weeklyStats.mem_avg_7d).toFixed(1),\n  tcp_retrans_total: weeklyStats.tcp_retrans.reduce((a, b) => a + b, 0)\n};\n\nreturn [{\n  json: {\n    summary,\n    problem_hosts,\n    healthy_hosts,\n    all_hosts: processedHosts,\n    config: cfg\n  }\n}];"
      },
      "id": "dcc91349-beea-47ba-9806-c2ddff426ab8",
      "name": "Alert Correlation v8.0",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        992,
        688
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-skip-llm",
              "leftValue": "={{ $json.problem_hosts.length === 0 && $json.summary.hosts_critical === 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d834c216-3904-4bfa-ab0e-3536b0fa50d6",
      "name": "Should Skip LLM?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1200,
        704
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "exec-summary",
              "name": "executive_summary_html",
              "value": "=<p>âœ… <strong>All systems healthy.</strong> No issues detected across {{ $json.summary.hosts_total }} monitored hosts.</p>",
              "type": "string"
            },
            {
              "id": "key-points",
              "name": "key_points",
              "value": "=[\n  \"All {{ $json.summary.hosts_up }} hosts operational\",\n  \"No critical alerts or resource constraints\",\n  \"Network and storage systems performing normally\"\n]",
              "type": "object"
            },
            {
              "id": "callouts",
              "name": "callouts",
              "value": "[]",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "d88127a1-d7cc-4711-82b8-8afcfd866e97",
      "name": "Healthy Report Bypass",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1408,
        608
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "={{ $('Configuration v3.0').item.json.llm_model }}",
          "mode": "id"
        },
        "responses": {
          "values": [
            {
              "role": "system",
              "content": "You are a Senior Site Reliability Engineer generating infrastructure health reports with PREDICTIVE INSIGHTS.\n\n### YOUR TASK\nAnalyze the JSON data (including predictions, anomalies, and trends) and generate a report. Output ONLY valid JSON with NO markdown.\n\n### CRITICAL INTERPRETATION RULES\n\n**PREDICTIONS TO HIGHLIGHT:**\n1. **disk_full_in_days**: If <30 days, CRITICAL. If <90 days, mention in summary.\n   - Example: \"docker-proxmox disk will be full in 27 days at current growth rate\"\n\n2. **mem_pressure_in_days**: MEMORY LEAK detected if present\n   - Example: \"truenas shows memory leak: +1.2%/day, will hit 90% in 18 days\"\n\n3. **cpu_anomaly_detected**: Unusual spike worth investigating\n   - Example: \"aarhus-pi had CPU spike to 94% (normally 2%)\"\n\n4. **network_saturation_risk**: Bandwidth issue upcoming\n   - Example: \"truenas using 75% of 10Gbps link capacity\"\n\n5. **disk_performance**: If \"degraded\" or \"poor\", mention\n   - Example: \"pve disk latency degraded (15ms average)\"\n\n6. **stability_score**: If <80, investigate causes\n   - Example: \"ubuntu-server stability: 65/100 (multiple reboots)\"\n\n**PATTERN-SPECIFIC ACTIONS:**\n- memory_leak â†’ \"Monitor: watch 'ps aux --sort=-%mem | head'. Consider container restart.\"\n- cpu_anomaly â†’ \"Review cron jobs: crontab -l. Check: journalctl --since yesterday\"\n- network_saturation â†’ \"Monitor: iftop. Consider link upgrade if sustained >70%\"\n- slow_disk â†’ \"Check SMART: smartctl -a. Review RAID status if applicable\"\n\n**WEEK-OVER-WEEK INSIGHTS:**\n- CPU down >30% â†’ \"Excellent: Load reduced significantly\"\n- CPU up >30% â†’ \"Investigate: What changed?\"\n- Memory stable â†’ \"Good: No leaks detected\"\n- Memory growing â†’ \"Warning: Potential leak, see predictions\"\n\n### REQUIRED OUTPUT FORMAT\n{\n  \"executive_summary_html\": \"<p>Professional summary with SLA status, predictions, and key trends. Mention: disk predictions, memory leaks, anomalies, network risks.</p>\",\n  \"key_points\": [\n    \"Include: uptime, SLA status\",\n    \"Predictions: disk full dates, memory leak projections\",\n    \"Anomalies: CPU spikes, network saturation\",\n    \"Trends: week-over-week changes with interpretation\",\n    \"Actions: specific remediation steps\"\n  ],\n  \"callouts\": [\n    {\n      \"host\": \"exact hostname\",\n      \"severity\": \"critical\" or \"warn\",\n      \"issue\": \"Brief description including prediction if relevant\",\n      \"action\": \"Specific command or step based on pattern type\"\n    }\n  ]\n}\n\n**INSIGHT QUALITY:**\n- Always mention predictions (disk/memory) if present\n- Explain WHY metrics changed (e.g., \"CPU down 46% likely due to reduced workload\")\n- Correlate issues (e.g., \"Network drops coincide with high bandwidth usage\")\n- Provide specific commands in actions\n- Celebrate improvements (e.g., \"Excellent stability week with 100% uptime\")"
            },
            {
              "content": "={{ JSON.stringify($json) }}"
            }
          ]
        },
        "builtInTools": {},
        "options": {
          "temperature": 1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        1408,
        800
      ],
      "id": "58d65f31-1718-4542-a728-b6e12a9e52da",
      "name": "LLM Report Generator",
      "credentials": {
        "openAiApi": {
          "id": "RyKkRker9vQRkEI4",
          "name": "OpenAi account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// PARSE JSON v4.0 - Robust LLM Output Handler\n\nconst input = $json;\nconst tryParse = s => {\n  if (typeof s !== 'string') return null;\n  const cleaned = s.replace(/^```json\\s*/i, '').replace(/```$/i, '').trim();\n  try { return JSON.parse(cleaned); } catch { return null; }\n};\n\nfunction looksValid(x) {\n  return x && typeof x === 'object' && (x.executive_summary_html || x.key_points || x.callouts);\n}\n\nconst candidates = [\n  input?.output?.content,\n  input?.output?.[0]?.content?.[0]?.text,\n  input?.message?.content,\n  input?.text,\n  input?.response?.content,\n  input\n];\n\nlet parsedData = null;\n\nfor (const c of candidates) {\n  if (!c) continue;\n  if (typeof c === 'object' && looksValid(c)) {\n    parsedData = c;\n    break;\n  }\n  if (typeof c === 'string') {\n    const p = tryParse(c);\n    if (looksValid(p)) {\n      parsedData = p;\n      break;\n    }\n  }\n}\n\nif (!parsedData) {\n  const metrics = (() => {\n    try { return $items('Alert Correlation v8.0')?.[0]?.json ?? {}; }\n    catch { return {}; }\n  })();\n  const s = metrics.summary || {};\n\n  parsedData = {\n    executive_summary_html: `<p>âš ï¸ LLM parsing failed. Hosts Up: ${s.hosts_up}/${s.hosts_total}. Critical: ${s.hosts_critical}, Warnings: ${s.hosts_warn}.</p>`,\n    key_points: [\n      `Automated Summary (LLM Error)`,\n      `Critical Hosts: ${s.hosts_critical || 0}`,\n      `Warning Hosts: ${s.hosts_warn || 0}`\n    ],\n    callouts: []\n  };\n}\n\nreturn [{ json: parsedData }];"
      },
      "id": "4fe159b2-77b0-4af6-a6eb-6e9c9136d545",
      "name": "Parse JSON v4.0",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        704
      ]
    },
    {
      "parameters": {
        "jsCode": "// ==========================================\n// HTML REPORT BUILDER v16.0 - ULTIMATE (v2.1 predictive insights)\n// Features: Sparklines, Gauges, Multi-Site, SLA, Trends\n// ==========================================\n\nconst CONFIG_NODE = 'Configuration v3.0';\nconst COMBINE_NODE = 'Combine Metrics v6.0';\nconst CORRELATION_NODE = 'Alert Correlation v8.0';\n\nconst aiData = $json;\nconst cfg = (() => { try { return $items(CONFIG_NODE)?.[0]?.json ?? {}; } catch { return {}; } })();\nconst rawData = (() => { try { return $items(COMBINE_NODE)?.[0]?.json ?? {}; } catch { return {}; } })();\nconst correlationData = (() => { try { return $items(CORRELATION_NODE)?.[0]?.json ?? {}; } catch { return {}; } })();\n\nconst summary = correlationData.summary || {};\nconst allHosts = correlationData.all_hosts || [];\nconst globalTh = rawData.thresholds || {};\n\nconst reportDate = summary.report_date || new Date().toISOString().slice(0, 10);\nconst genTime = new Date().toLocaleTimeString('en-GB', {\n  hour: '2-digit',\n  minute: '2-digit',\n  timeZone: cfg.timezone || 'UTC'\n});\n\nconst hostsUp = summary.hosts_up || 0;\nconst hostsTotal = summary.hosts_total || 0;\nconst critCount = summary.hosts_critical || 0;\nconst warnCount = summary.hosts_warn || 0;\nconst totalAlerts = critCount + warnCount;\n\nconst status = critCount > 0 ? 'critical' : warnCount > 0 ? 'warn' : 'ok';\nconst statusConfig = {\n  critical: { label: 'CRITICAL ATTENTION', color: '#EF4444' },\n  warn: { label: 'SYSTEM DEGRADED', color: '#F59E0B' },\n  ok: { label: 'SYSTEM HEALTHY', color: '#10B981' }\n};\nconst currentStatus = statusConfig[status];\nconst healthScore = hostsTotal > 0 ? Math.round((hostsUp / hostsTotal) * 100) : 0;\n\nconst escapeHtml = s => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\nconst isNum = x => typeof x === 'number' && Number.isFinite(x);\nconst fmtUptime = sec => isNum(sec) ? (sec < 86400 ? `${Math.floor(sec/3600)}h` : `${Math.floor(sec/86400)}d`) : 'â€”';\nconst fmtBytes = (bps) => {\n  if (!isNum(bps)) return '0b';\n  if (bps > 1000000000) return (bps / 1000000000).toFixed(1) + 'G';\n  if (bps > 1000000) return (bps / 1000000).toFixed(1) + 'M';\n  if (bps > 1000) return (bps / 1000).toFixed(0) + 'k';\n  return bps.toFixed(0) + 'b';\n};\n\nconst COLORS = {\n  critical: { bg: '#FEF2F2', border: '#FECACA', text: '#991B1B', bar: '#EF4444' },\n  warn: { bg: '#FFFBEB', border: '#FDE68A', text: '#92400E', bar: '#F59E0B' },\n  ok: { bg: '#ECFDF5', border: '#A7F3D0', text: '#065F46', bar: '#10B981' },\n  header: { bgStart: '#0F172A', bgEnd: '#334155', text: '#FFFFFF' }\n};\n\n// SPARKLINE GENERATOR\nconst renderSparkline = (values) => {\n  if (!values || values.length < 2) return '<span style=\"color:#D1D5DB;font-size:9px;\">â€”</span>';\n  const max = Math.max(...values, 1);\n  const min = Math.min(...values, 0);\n  const range = max - min || 1;\n  const width = 60;\n  const height = 20;\n  const points = values.map((v, i) => {\n    const x = (i / (values.length - 1)) * width;\n    const y = height - ((v - min) / range) * height;\n    return `${x.toFixed(1)},${y.toFixed(1)}`;\n  }).join(' ');\n\n  const color = max > 80 ? '#EF4444' : max > 60 ? '#F59E0B' : '#10B981';\n\n  return `<svg width=\"${width}\" height=\"${height}\" style=\"vertical-align:middle;\">\n    <polyline points=\"${points}\" fill=\"none\" stroke=\"${color}\" stroke-width=\"1.5\"/>\n  </svg>`;\n};\n\n// GAUGE GENERATOR\nconst renderGauge = (value) => {\n  const angle = Math.min(Math.max(value, 0), 100) * 1.8;\n  const color = value < 90 ? '#EF4444' : value < 95 ? '#F59E0B' : '#10B981';\n  const x2 = 60 + 45 * Math.cos((angle - 90) * Math.PI / 180);\n  const y2 = 50 + 45 * Math.sin((angle - 90) * Math.PI / 180);\n\n  return `<svg width=\"120\" height=\"70\" viewBox=\"0 0 120 70\">\n    <path d=\"M 15 50 A 45 45 0 0 1 105 50\" fill=\"none\" stroke=\"#E5E7EB\" stroke-width=\"8\" stroke-linecap=\"round\"/>\n    <path d=\"M 15 50 A 45 45 0 ${angle > 90 ? 1 : 0} 1 ${x2} ${y2}\" fill=\"none\" stroke=\"${color}\" stroke-width=\"8\" stroke-linecap=\"round\"/>\n    <text x=\"60\" y=\"55\" text-anchor=\"middle\" font-size=\"18\" font-weight=\"bold\" fill=\"#1F2937\">${value}%</text>\n  </svg>`;\n};\n\n// PROGRESS BAR\nconst renderBar = (val, warnTh, critTh) => {\n  if (!isNum(val)) return `<div style=\"color:#D1D5DB;font-size:10px;text-align:center;\">â€”</div>`;\n  let color = COLORS.ok.bar;\n  if (val >= critTh) color = COLORS.critical.bar;\n  else if (val >= warnTh) color = COLORS.warn.bar;\n  const width = Math.min(Math.max(val, 0), 100);\n  return `\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-top:2px;\">\n      <tr>\n        <td width=\"28\" style=\"font-size:10px;font-weight:700;color:#374151;vertical-align:middle;line-height:1;\">${Math.round(val)}%</td>\n        <td style=\"vertical-align:middle;\">\n          <div style=\"height:5px;background-color:#E5E7EB;border-radius:2px;overflow:hidden;line-height:0;\">\n            <div style=\"width:${width}%;background-color:${color};height:5px;line-height:0;\">&nbsp;</div>\n          </div>\n        </td>\n      </tr>\n    </table>`;\n};\n\n// KPI CARD\nconst renderKpi = (label, value, subtext, colorCode) => `\n  <td width=\"25%\" style=\"padding:0 6px;\">\n    <div style=\"background-color:#fff;border:1px solid #E5E7EB;border-radius:8px;padding:12px;text-align:center;\">\n      <div style=\"font-size:9px;font-weight:700;color:#9CA3AF;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:4px;\">${label}</div>\n      <div style=\"font-size:20px;font-weight:800;color:${colorCode};letter-spacing:-0.5px;\">${value}</div>\n      <div style=\"font-size:9px;font-weight:600;color:${colorCode};margin-top:2px;\">${subtext}</div>\n    </div>\n  </td>`;\n\n// SITE SLA TABLE\nlet siteSlaHtml = '';\nif (summary.site_health && Object.keys(summary.site_health).length > 0) {\n  const siteRows = Object.entries(summary.site_health).map(([name, data]) => {\n    const statusIcon = data.meets_sla ? 'âœ…' : 'âš ï¸';\n    const statusColor = data.meets_sla ? '#10B981' : '#F59E0B';\n    return `\n      <tr style=\"border-bottom:1px solid #E5E7EB;\">\n        <td style=\"padding:8px 12px;font-size:11px;font-weight:600;color:#374151;\">${escapeHtml(name)}</td>\n        <td style=\"padding:8px 12px;text-align:center;font-size:10px;color:#6B7280;\">${data.up}/${data.total}</td>\n        <td style=\"padding:8px 12px;text-align:center;font-size:11px;font-weight:700;color:${statusColor};\">${statusIcon} ${data.sla}%</td>\n        <td style=\"padding:8px 12px;text-align:center;font-size:10px;color:#9CA3AF;\">${data.target}%</td>\n      </tr>`;\n  }).join('');\n\n  siteSlaHtml = `\n    <tr>\n      <td style=\"padding:20px 24px;border-bottom:1px solid #F3F4F6;\">\n        <div style=\"font-size:10px;font-weight:800;color:#9CA3AF;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;\">SITE SLA COMPLIANCE</div>\n        <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border:1px solid #E5E7EB;border-radius:8px;overflow:hidden;\">\n          <thead>\n            <tr style=\"background-color:#F9FAFB;\">\n              <th align=\"left\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Site</th>\n              <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Hosts</th>\n              <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Actual SLA</th>\n              <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Target</th>\n            </tr>\n          </thead>\n          <tbody>${siteRows}</tbody>\n        </table>\n      </td>\n    </tr>`;\n}\n\n// WEEK-OVER-WEEK TRENDS\nlet trendsHtml = '';\nif (summary.week_over_week) {\n  const wow = summary.week_over_week;\n  const cpuChange = ((parseFloat(wow.cpu_avg_current) - parseFloat(wow.cpu_avg_7d)) / parseFloat(wow.cpu_avg_7d) * 100).toFixed(0);\n  const memChange = ((parseFloat(wow.mem_avg_current) - parseFloat(wow.mem_avg_7d)) / parseFloat(wow.mem_avg_7d) * 100).toFixed(0);\n\n  const cpuArrow = cpuChange > 0 ? 'â†—' : cpuChange < 0 ? 'â†˜' : 'â†’';\n  const memArrow = memChange > 0 ? 'â†—' : memChange < 0 ? 'â†˜' : 'â†’';\n\n  const cpuColor = Math.abs(cpuChange) > 20 ? '#F59E0B' : '#6B7280';\n  const memColor = Math.abs(memChange) > 20 ? '#F59E0B' : '#6B7280';\n\n  trendsHtml = `\n    <tr>\n      <td style=\"padding:20px 24px;border-bottom:1px solid #F3F4F6;\">\n        <div style=\"font-size:10px;font-weight:800;color:#9CA3AF;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;\">WEEK-OVER-WEEK TRENDS</div>\n        <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border:1px solid #E5E7EB;border-radius:8px;overflow:hidden;\">\n          <thead>\n            <tr style=\"background-color:#F9FAFB;\">\n              <th align=\"left\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Metric</th>\n              <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Current</th>\n              <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">7d Avg</th>\n              <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Change</th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr style=\"border-bottom:1px solid #E5E7EB;\">\n              <td style=\"padding:8px 12px;font-size:11px;font-weight:600;color:#374151;\">CPU Usage</td>\n              <td style=\"padding:8px 12px;text-align:center;font-size:11px;color:#1F2937;\">${wow.cpu_avg_current}%</td>\n              <td style=\"padding:8px 12px;text-align:center;font-size:11px;color:#6B7280;\">${wow.cpu_avg_7d}%</td>\n              <td style=\"padding:8px 12px;text-align:center;font-size:11px;font-weight:700;color:${cpuColor};\">${cpuArrow} ${cpuChange}%</td>\n            </tr>\n            <tr style=\"border-bottom:1px solid #E5E7EB;\">\n              <td style=\"padding:8px 12px;font-size:11px;font-weight:600;color:#374151;\">Memory Usage</td>\n              <td style=\"padding:8px 12px;text-align:center;font-size:11px;color:#1F2937;\">${wow.mem_avg_current}%</td>\n              <td style=\"padding:8px 12px;text-align:center;font-size:11px;color:#6B7280;\">${wow.mem_avg_7d}%</td>\n              <td style=\"padding:8px 12px;text-align:center;font-size:11px;font-weight:700;color:${memColor};\">${memArrow} ${memChange}%</td>\n            </tr>\n            <tr>\n              <td style=\"padding:8px 12px;font-size:11px;font-weight:600;color:#374151;\">TCP Retrans (24h)</td>\n              <td colspan=\"3\" style=\"padding:8px 12px;text-align:center;font-size:11px;color:#1F2937;\">${wow.tcp_retrans_total}</td>\n            </tr>\n          </tbody>\n        </table>\n      </td>\n    </tr>`;\n}\n\n// PREDICTIVE INSIGHTS SECTION (NEW!)\nlet insightsHtml = '';\nconst predictions = allHosts.filter(h =>\n  h.disk_full_in_days || h.mem_pressure_in_days || h.cpu_anomaly_detected ||\n  h.network_saturation_risk || h.disk_performance === 'degraded' || h.disk_performance === 'poor'\n);\n\nif (predictions.length > 0) {\n  const insightRows = predictions.map(h => {\n    const insights = [];\n\n    if (h.disk_full_in_days && h.disk_full_in_days < 90) {\n      const color = h.disk_full_in_days < 30 ? '#EF4444' : '#F59E0B';\n      insights.push(`<span style=\"color:${color};\">ðŸ’¾ Disk full in ${h.disk_full_in_days}d (${h.disk_growth_gb_per_week}GB/week)</span>`);\n    }\n\n    if (h.mem_pressure_in_days) {\n      const color = h.mem_pressure_in_days < 21 ? '#EF4444' : '#F59E0B';\n      insights.push(`<span style=\"color:${color};\">ðŸ§  Mem leak: +${h.mem_growth_rate_daily}%/day (90% in ${h.mem_pressure_in_days}d)</span>`);\n    }\n\n    if (h.cpu_anomaly_detected) {\n      insights.push(`<span style=\"color:#F59E0B;\">âš¡ CPU spike: ${h.cpu_spike_max}% detected</span>`);\n    }\n\n    if (h.network_saturation_risk) {\n      insights.push(`<span style=\"color:#F59E0B;\">ðŸŒ Network: ${h.network_utilization_pct}% capacity</span>`);\n    }\n\n    if (h.disk_performance === 'degraded' || h.disk_performance === 'poor') {\n      insights.push(`<span style=\"color:#F59E0B;\">â±ï¸ Disk: ${h.disk_performance} performance</span>`);\n    }\n\n    if (insights.length === 0) return '';\n\n    return `\n      <tr style=\"border-bottom:1px solid #E5E7EB;\">\n        <td style=\"padding:8px 12px;font-size:11px;font-weight:600;color:#374151;\">${escapeHtml(h.display_name)}</td>\n        <td style=\"padding:8px 12px;font-size:10px;color:#4B5563;\">${insights.join('<br>')}</td>\n      </tr>`;\n  }).filter(Boolean).join('');\n\n  if (insightRows) {\n    insightsHtml = `\n    <tr>\n      <td style=\"padding:20px 24px;border-bottom:1px solid #F3F4F6;\">\n        <div style=\"font-size:10px;font-weight:800;color:#9CA3AF;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;\">ðŸ”® PREDICTIVE INSIGHTS</div>\n        <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border:1px solid #E5E7EB;border-radius:8px;overflow:hidden;\">\n          <thead>\n            <tr style=\"background-color:#F9FAFB;\">\n              <th align=\"left\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Host</th>\n              <th align=\"left\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;\">Predictions & Anomalies</th>\n            </tr>\n          </thead>\n          <tbody>${insightRows}</tbody>\n        </table>\n      </td>\n    </tr>`;\n  }\n}\n\n// CALLOUTS\nlet callouts = (aiData.callouts || []).filter(c => c.host && c.issue).slice(0, 12);\nlet calloutsHtml = '';\nif (callouts.length > 0) {\n  const cards = callouts.map(c => {\n    const theme = COLORS[c.severity] || COLORS.warn;\n    const badgeText = c.severity === 'critical' ? 'CRITICAL' : 'WARNING';\n    return `\n      <tr>\n        <td style=\"padding-bottom:10px;\">\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border:1px solid ${theme.border};background-color:${theme.bg};border-radius:8px;\">\n            <tr>\n              <td style=\"padding:12px 16px;\">\n                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\n                  <tr>\n                    <td>\n                      <span style=\"background-color:#fff;color:${theme.text};font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;border:1px solid ${theme.border};letter-spacing:0.5px;\">${badgeText}</span>\n                      <span style=\"margin-left:8px;font-weight:700;color:${theme.text};font-size:12px;\">${escapeHtml(c.host)}</span>\n                    </td>\n                  </tr>\n                  <tr><td style=\"padding-top:6px;font-size:12px;font-weight:600;color:#1F2937;\">${escapeHtml(c.issue)}</td></tr>\n                  <tr><td style=\"padding-top:4px;font-size:11px;color:#4B5563;line-height:1.4;\"><strong style=\"color:${theme.text};\">Action:</strong> ${escapeHtml(c.action || 'Investigate.')}</td></tr>\n                </table>\n              </td>\n            </tr>\n          </table>\n        </td>\n      </tr>`;\n  }).join('');\n  calloutsHtml = `<tr><td style=\"padding:24px 30px 10px 30px;border-bottom:1px solid #F3F4F6;\"><div style=\"font-size:10px;font-weight:800;color:#9CA3AF;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;\">PRIORITY ACTIONS</div><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">${cards}</table></td></tr>`;\n}\n\n// HOST ROWS\nconst hostRows = allHosts.map((h, i) => {\n  const bg = i % 2 === 0 ? '#FFFFFF' : '#F9FAFB';\n  const nameColor = h.status === 'ok' ? '#374151' : (h.status === 'critical' ? '#EF4444' : '#F59E0B');\n  const dotColor = h.status === 'ok' ? '#10B981' : (h.status === 'critical' ? '#EF4444' : '#F59E0B');\n\n  const cpuSparkline = h.trends?.cpu_sparkline ? renderSparkline(h.trends.cpu_sparkline) : '<span style=\"color:#D1D5DB;font-size:9px;\">â€”</span>';\n  const memSparkline = h.trends?.mem_sparkline ? renderSparkline(h.trends.mem_sparkline) : '<span style=\"color:#D1D5DB;font-size:9px;\">â€”</span>';\n\n  const totalDrops = (h.net_drop_rx_24h || 0) + (h.net_drop_tx_24h || 0);\n  const totalErrors = (h.net_err_rx_24h || 0) + (h.net_err_tx_24h || 0);\n  const retrans = h.tcp_retrans_24h || 0;\n\n  let netColor = '#6B7280';\n  let netText = fmtBytes(h.net_tx_bps || 0) + ' â†‘';\n\n  if (totalDrops > 1000) {\n    netColor = '#EF4444';\n    netText = `<span style=\"color:#EF4444;font-weight:700;\">${Math.round(totalDrops/1000)}k Drop</span>`;\n  } else if (retrans > 5000) {\n    netColor = '#F59E0B';\n    netText = `<span style=\"color:#F59E0B;\">${Math.round(retrans/1000)}k Retx</span>`;\n  } else if (totalErrors > 100) {\n    netColor = '#F59E0B';\n    netText = `<span style=\"color:#F59E0B;\">${totalErrors} Err</span>`;\n  }\n\n  // Disk prediction\n  let diskText = h.fs_usage_percent != null ? `${Math.round(h.fs_usage_percent)}%` : 'â€”';\n  if (h.disk_full_in_days != null && h.disk_full_in_days < 30) {\n    diskText += ` <span style=\"color:#EF4444;font-size:9px;\">(${h.disk_full_in_days}d)</span>`;\n  }\n\n  return `\n    <tr style=\"background-color:${bg};\">\n      <td style=\"padding:8px 12px;border-bottom:1px solid #E5E7EB;vertical-align:middle;\">\n        <span style=\"color:${dotColor};font-size:14px;line-height:10px;vertical-align:middle;\">â€¢</span>\n        <strong style=\"font-size:11px;color:${nameColor};margin-left:4px;\">${escapeHtml(h.display_name)}</strong>\n      </td>\n      <td style=\"padding:8px 12px;border-bottom:1px solid #E5E7EB;font-size:10px;color:#6B7280;text-align:right;vertical-align:middle;\">${fmtUptime(h.uptime_seconds)}</td>\n      <td style=\"padding:8px 12px;border-bottom:1px solid #E5E7EB;vertical-align:middle;\">${renderBar(h.cpu_usage_percent, globalTh.cpu_warn, globalTh.cpu_crit)}</td>\n      <td style=\"padding:8px 12px;border-bottom:1px solid #E5E7EB;text-align:center;vertical-align:middle;\">${cpuSparkline}</td>\n      <td style=\"padding:8px 12px;border-bottom:1px solid #E5E7EB;vertical-align:middle;\">${renderBar(h.mem_usage_percent, globalTh.mem_warn, globalTh.mem_crit)}</td>\n      <td style=\"padding:8px 12px;border-bottom:1px solid #E5E7EB;text-align:center;vertical-align:middle;\">${memSparkline}</td>\n      <td style=\"padding:8px 12px;border-bottom:1px solid #E5E7EB;font-size:10px;color:#6B7280;text-align:center;vertical-align:middle;\">${diskText}</td>\n      <td style=\"padding:8px 12px;border-bottom:1px solid #E5E7EB;font-size:10px;font-weight:600;color:${netColor};text-align:right;vertical-align:middle;\">${netText}</td>\n    </tr>`;\n}).join('');\n\nconst execHtml = aiData.executive_summary_html || '<p>Report generated.</p>';\nconst keyPoints = (aiData.key_points || []).slice(0, 5);\nconst keyPointsHtml = keyPoints.length > 0 ? `<ul style=\"margin:10px 0 0;padding-left:18px;color:#4B5563;font-size:12px;line-height:1.5;\">${keyPoints.map(k => `<li style=\"margin-bottom:3px;\">${escapeHtml(k)}</li>`).join('')}</ul>` : '';\n\nconst subject = `${status === 'ok' ? 'âœ…' : (status === 'critical' ? 'ðŸš¨' : 'âš ï¸')} ${cfg.report_title || 'System Health Report'} - ${reportDate}`;\n\nconst html = `\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n<head>\n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n  <title>${escapeHtml(subject)}</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n  <style type=\"text/css\">\n    body { margin: 0; padding: 0; background-color: #F3F4F6; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }\n    table { border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; }\n  </style>\n</head>\n<body style=\"margin:0;padding:0;background-color:#F3F4F6;\">\n  <center>\n    <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#F3F4F6;padding:20px 0;\">\n      <tr>\n        <td align=\"center\">\n          <table width=\"700\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#FFFFFF;border-radius:12px;overflow:hidden;border:1px solid #E5E7EB;border-collapse:separate;\">\n\n            <!-- HEADER -->\n            <tr>\n              <td style=\"background:linear-gradient(135deg, ${COLORS.header.bgStart} 0%, ${COLORS.header.bgEnd} 100%);padding:28px;\">\n                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\n                  <tr>\n                    <td>\n                      <div style=\"color:#94A3B8;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;\">${escapeHtml(cfg.company_name || 'InfraOps')}</div>\n                      <div style=\"color:#FFFFFF;font-size:24px;font-weight:800;letter-spacing:-0.5px;margin:4px 0;\">SYSTEM PULSE</div>\n                      <div style=\"color:#CBD5E1;font-size:12px;\">${escapeHtml(cfg.report_title || 'Daily System Health Report')}</div>\n                    </td>\n                    <td align=\"right\" style=\"vertical-align:middle;\">\n                      <div style=\"background-color:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:6px 12px;text-align:right;\">\n                        <div style=\"color:#FFFFFF;font-size:12px;font-weight:700;\">${reportDate}</div>\n                        <div style=\"color:#94A3B8;font-size:10px;\">${genTime}</div>\n                      </div>\n                    </td>\n                  </tr>\n                </table>\n              </td>\n            </tr>\n\n            <!-- KPIs -->\n            <tr>\n              <td style=\"padding:20px 24px;border-bottom:1px solid #F3F4F6;\">\n                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\n                  <tr>\n                    ${renderKpi('Status', currentStatus.label.split(' ')[1], currentStatus.label.split(' ')[0], currentStatus.color)}\n                    <td width=\"25%\" style=\"padding:0 6px;\">\n                      <div style=\"background-color:#fff;border:1px solid #E5E7EB;border-radius:8px;padding:12px;text-align:center;\">\n                        <div style=\"font-size:9px;font-weight:700;color:#9CA3AF;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:4px;\">Health Score</div>\n                        ${renderGauge(healthScore)}\n                      </div>\n                    </td>\n                    ${renderKpi('Hosts Up', `${hostsUp}/${hostsTotal}`, 'ONLINE', hostsUp < hostsTotal ? COLORS.critical.bar : '#374151')}\n                    ${renderKpi('Active Alerts', totalAlerts, 'ISSUES', totalAlerts > 0 ? COLORS.warn.bar : COLORS.ok.bar)}\n                  </tr>\n                </table>\n              </td>\n            </tr>\n\n            <!-- EXECUTIVE SUMMARY -->\n            <tr>\n              <td style=\"padding:20px 24px;border-bottom:1px solid #F3F4F6;\">\n                <div style=\"font-size:10px;font-weight:800;color:#9CA3AF;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;\">EXECUTIVE SUMMARY</div>\n                <div style=\"font-size:13px;color:#374151;line-height:1.6;\">${execHtml}</div>\n                ${keyPointsHtml}\n                ${summary.incidents_30d > 0 ? `<div style=\"margin-top:10px;font-size:11px;color:#6B7280;\">ðŸ“Š <strong>${summary.incidents_30d}</strong> incidents in last 30 days</div>` : ''}\n              </td>\n            </tr>\n\n            ${siteSlaHtml}\n            ${trendsHtml}\n            ${insightsHtml}\n            ${calloutsHtml}\n\n            <!-- HOST TABLE -->\n            <tr>\n              <td style=\"padding:20px 24px;\">\n                <div style=\"font-size:10px;font-weight:800;color:#9CA3AF;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;\">INFRASTRUCTURE METRICS</div>\n                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"border:1px solid #E5E7EB;border-radius:8px;overflow:hidden;border-collapse:separate;\">\n                  <thead>\n                    <tr style=\"background-color:#F9FAFB;\">\n                      <th align=\"left\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;border-bottom:1px solid #E5E7EB;\">Host</th>\n                      <th align=\"right\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;border-bottom:1px solid #E5E7EB;\">Uptime</th>\n                      <th align=\"left\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;border-bottom:1px solid #E5E7EB;\">CPU</th>\n                      <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;border-bottom:1px solid #E5E7EB;\">7d</th>\n                      <th align=\"left\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;border-bottom:1px solid #E5E7EB;\">Mem</th>\n                      <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;border-bottom:1px solid #E5E7EB;\">7d</th>\n                      <th align=\"center\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;border-bottom:1px solid #E5E7EB;\">Disk</th>\n                      <th align=\"right\" style=\"padding:8px 12px;font-size:9px;font-weight:700;color:#6B7280;text-transform:uppercase;border-bottom:1px solid #E5E7EB;\">Net/Err</th>\n                    </tr>\n                  </thead>\n                  <tbody>${hostRows}</tbody>\n                </table>\n              </td>\n            </tr>\n\n            <!-- FOOTER -->\n            <tr>\n              <td align=\"center\" style=\"padding:20px;background-color:#F8FAFC;border-top:1px solid #E5E7EB;color:#9CA3AF;font-size:10px;\">\n                <div style=\"margin-bottom:4px;font-weight:600;\">Generated via n8n â€¢ Report v16.0 Ultimate</div>\n                <div>${hostsTotal} Hosts â€¢ Sparklines â€¢ SLA Tracking â€¢ Pattern Detection â€¢ Predictive Insights</div>\n              </td>\n            </tr>\n          </table>\n          <div style=\"height:30px;\">&nbsp;</div>\n        </td>\n      </tr>\n    </table>\n  </center>\n</body>\n</html>\n`;\n\nreturn [{ json: { subject, html, date: reportDate, status, critCount, warnCount } }];"
      },
      "id": "b73a2295-8b03-4634-bfdd-a5fd491f62a5",
      "name": "Build HTML v16.0",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1808,
        704
      ]
    },
    {
      "parameters": {
        "jsCode": "const staticData = $getWorkflowStaticData('global');\nconst key = `pulse|${$json.date || new Date().toISOString().slice(0,10)}`;\nconst alreadySent = staticData.lastSentKey === key;\nreturn [{ json: { ...$json, report_key: key, already_sent: alreadySent } }];"
      },
      "id": "aa300b85-6019-4f82-8a83-2c1e78cb65d5",
      "name": "Idempotency Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        704
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.already_sent }}",
              "operation": "isFalse"
            }
          ]
        },
        "options": {}
      },
      "id": "8e4be216-6c90-446d-9cd4-90a58a75dd22",
      "name": "Not Sent Yet?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2208,
        704
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ $('Configuration v3.0').item.json.email_recipient }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.html }}",
        "options": {
          "appendAttribution": false
        }
      },
      "id": "ca50aaa0-c514-4a98-bb76-88ffafdc33f6",
      "name": "Send Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        2400,
        608
      ],
      "webhookId": "2e33879a-048e-46d1-bdd0-1d08ad46c7f3",
      "credentials": {
        "gmailOAuth2": {
          "id": "f5vJ92YW8MuZKk0G",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-webhook",
              "leftValue": "={{ $('Configuration v3.0').item.json.slack_webhook }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "should-send",
              "leftValue": "={{ $json.critCount > 0 || !$('Configuration v3.0').item.json.slack_critical_only }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "96c3e210-99fc-458b-bbc6-f773f9bceea5",
      "name": "Send to Slack?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2656,
        896
      ]
    },
    {
      "parameters": {
        "url": "={{ $('Configuration v3.0').item.json.slack_webhook }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "=ðŸš¨ *CRITICAL INFRASTRUCTURE ALERT* - {{ $json.date }}"
            },
            {
              "name": "blocks",
              "value": "=[\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"*{{ $json.critCount }} Critical Issues Detected*\\n{{ $json.subject }}\"\n    }\n  },\n  {\n    \"type\": \"divider\"\n  },\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"Check your email for full report.\"\n    }\n  }\n]"
            }
          ]
        },
        "options": {}
      },
      "id": "68147c38-a68c-435b-9e4a-3a2539397fcd",
      "name": "Slack Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2864,
        880
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const staticData = $getWorkflowStaticData('global');\nstaticData.lastSentKey = $json.report_key;\nstaticData.lastSentAt = new Date().toISOString();\nreturn [{ json: { ...$json, marked_sent: true } }];"
      },
      "id": "089c8f26-6202-4f46-862e-43f18c839ce0",
      "name": "Mark as Sent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2608,
        608
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "skip-reason",
              "name": "reason",
              "value": "Already sent today",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "c5bfba66-bdcb-47d4-b21f-f742f5880a86",
      "name": "Already Sent",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2384,
        1024
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Configuration v3.0",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Configuration v3.0": {
      "main": [
        [
          {
            "node": "Query: up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: up": {
      "main": [
        [
          {
            "node": "Query: avail_24h",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: avail_24h": {
      "main": [
        [
          {
            "node": "Query: cpu_usage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: cpu_usage": {
      "main": [
        [
          {
            "node": "Query: cpu_trend_7d",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: cpu_trend_7d": {
      "main": [
        [
          {
            "node": "Query: load_per_cpu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: load_per_cpu": {
      "main": [
        [
          {
            "node": "Query: mem_usage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: mem_usage": {
      "main": [
        [
          {
            "node": "Query: mem_trend_7d",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: mem_trend_7d": {
      "main": [
        [
          {
            "node": "Query: swap_usage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: swap_usage": {
      "main": [
        [
          {
            "node": "Query: fs_size",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: fs_size": {
      "main": [
        [
          {
            "node": "Query: fs_avail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: fs_avail": {
      "main": [
        [
          {
            "node": "Query: disk_growth_7d",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: disk_growth_7d": {
      "main": [
        [
          {
            "node": "Query: disk_busy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: disk_busy": {
      "main": [
        [
          {
            "node": "Query: disk_read_lat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: disk_read_lat": {
      "main": [
        [
          {
            "node": "Query: disk_write_lat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: disk_write_lat": {
      "main": [
        [
          {
            "node": "Query: net_rx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: net_rx": {
      "main": [
        [
          {
            "node": "Query: net_tx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: net_tx": {
      "main": [
        [
          {
            "node": "Query: net_drop_rx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: net_drop_rx": {
      "main": [
        [
          {
            "node": "Query: net_drop_tx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: net_drop_tx": {
      "main": [
        [
          {
            "node": "Query: net_err_rx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: net_err_rx": {
      "main": [
        [
          {
            "node": "Query: net_err_tx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: net_err_tx": {
      "main": [
        [
          {
            "node": "Query: net_interface_status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: net_interface_status": {
      "main": [
        [
          {
            "node": "Query: tcp_estab",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: tcp_estab": {
      "main": [
        [
          {
            "node": "Query: tcp_retrans",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: tcp_retrans": {
      "main": [
        [
          {
            "node": "Query: uptime",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: uptime": {
      "main": [
        [
          {
            "node": "Query: reboots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: reboots": {
      "main": [
        [
          {
            "node": "Query: uname",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: uname": {
      "main": [
        [
          {
            "node": "Query: cpu_count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: cpu_count": {
      "main": [
        [
          {
            "node": "Query: mem_total",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: mem_total": {
      "main": [
        [
          {
            "node": "Combine Metrics v6.0",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Metrics v6.0": {
      "main": [
        [
          {
            "node": "Alert Correlation v8.0",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alert Correlation v8.0": {
      "main": [
        [
          {
            "node": "Should Skip LLM?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Skip LLM?": {
      "main": [
        [
          {
            "node": "Healthy Report Bypass",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LLM Report Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Healthy Report Bypass": {
      "main": [
        [
          {
            "node": "Parse JSON v4.0",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Report Generator": {
      "main": [
        [
          {
            "node": "Parse JSON v4.0",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse JSON v4.0": {
      "main": [
        [
          {
            "node": "Build HTML v16.0",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build HTML v16.0": {
      "main": [
        [
          {
            "node": "Idempotency Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Idempotency Check": {
      "main": [
        [
          {
            "node": "Not Sent Yet?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Not Sent Yet?": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Already Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email": {
      "main": [
        [
          {
            "node": "Mark as Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Slack?": {
      "main": [
        [
          {
            "node": "Slack Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "653dcbde-722e-4ce8-a3ce-bda1d3744d85",
  "meta": {
    "instanceId": "1d58598686cefaad5542fdb4f6742136d958b8652d93a9be3cabc6d0874e8935"
  },
  "id": "yZm1Q2frdSxMOhy1",
  "tags": []
}